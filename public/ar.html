<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PINHAN BOX - WebAR</title>

    <!-- A-Frame & MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: sans-serif;
        }

        /* OVERLAY */
        #scan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .logo-container {
            width: 150px;
            height: 150px;
            margin-bottom: 40px;
            max-width: 50%;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .btn-start {
            padding: 16px 40px;
            background: #FFD700;
            border: none;
            border-radius: 50px;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
        }

        #error-msg {
            color: #ff4444;
            margin-top: 20px;
            font-size: 14px;
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            max-width: 90%;
        }

        /* 
           FORCE VIDEO VISIBILITY 
           MindAR creates a <video> element. We must ensure it's visible.
        */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -100 !important;
            /* Send way back */
            opacity: 1 !important;
            /* Force visible */
            display: block !important;
        }

        /* Canvas (AR overlay) must be transparent and on top */
        .a-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
            background: transparent !important;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            pointer-events: none;
        }

        /* Debug Console on Screen */
        #debug-console {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: lime;
            font-size: 10px;
            z-index: 10000;
            padding: 5px;
            display: none;
            /* Set to block if needed */
            max-height: 200px;
            overflow: auto;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div id="debug-console"></div>

    <!-- SCAN OVERLAY -->
    <div id="scan-overlay">
        <div class="logo-container">
            <img src="/watermark_logo.png" alt="Logo">
        </div>
        <button class="btn-start" id="btn-init">BOSHLASH</button>
        <p id="error-msg"></p>
        <p style="color: #666; font-size: 12px; margin-top: 15px;">v4.1 Check</p>
    </div>

    <div id="ui-layer"></div>
    <div id="ar-scene-container"></div>

    <script>
        const uuid = new URLSearchParams(window.location.search).get('id');
        const overlay = document.getElementById('scan-overlay');
        const btnInit = document.getElementById('btn-init');
        const errorMsg = document.getElementById('error-msg');
        const arContainer = document.getElementById('ar-scene-container');
        const debugConsole = document.getElementById('debug-console');

        // Debug Logger
        function log(msg) {
            console.log(msg);
            debugConsole.innerHTML += `> ${msg}<br>`;
        }

        function triggerError(msg) {
            log("ERROR: " + msg);
            errorMsg.innerText = msg;
            errorMsg.style.display = 'block';
            btnInit.style.display = 'block'; // Show button again to retry?
            alert("Xatolik: " + msg); // Alert for mobile user
        }

        // 1. Fetch
        async function fetchProject() {
            if (!uuid) return triggerError("ID topilmadi.");
            try {
                const res = await fetch(`/api/project/${uuid}`);
                if (!res.ok) throw new Error("Loyiha topilmadi");
                const data = await res.json();

                btnInit.onclick = () => startExperience(data);
                log("Data loaded. Ready to start.");
            } catch (err) {
                triggerError(err.message);
            }
        }

        // 2. Start
        function startExperience(data) {
            log("Starting Experience...");

            // Hide overlay first? Or keep until camera ready?
            // Let's hide overlay now but keep error msg area available
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 500);

            // Init AR logic
            const mRatio = data.markerRatio || 1.0;
            const vRatio = data.videoRatio || 1.0;
            const pHeight = 1 / mRatio;

            // Calculate fit
            let repeat = "1 1", offset = "0 0";
            if (vRatio > mRatio) {
                const s = mRatio / vRatio;
                repeat = `${s} 1`;
                offset = `${(1 - s) / 2} 0`;
            } else {
                const s = vRatio / mRatio;
                repeat = `1 ${s}`;
                offset = `0 ${(1 - s) / 2}`;
            }

            // Inject Scene
            // NOTE: MindAR doesn't use 'arjs' attribute. It uses 'mindar-image'.
            // forcing uiScanning: no to prevent default MindAR UI overlay conflict
            arContainer.innerHTML = `
                <a-scene 
                    mindar-image="imageTargetSrc: ${data.mind}; uiLoading: no; uiScanning: no; uiError: no;" 
                    renderer="colorManagement: true, preserveDrawingBuffer: true"
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: false">
                    
                    <a-assets>
                        <video id="ar-video" src="${data.video}" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
                    </a-assets>

                    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

                    <a-entity mindar-image-target="targetIndex: 0">
                        <a-plane 
                            material="src: #ar-video; opacity: 1; transparent: false; repeat: ${repeat}; offset: ${offset}" 
                            position="0 0 0" 
                            width="1" 
                            height="${pHeight}">
                        </a-plane>
                    </a-entity>
                </a-scene>
            `;

            // 3. Handle Events & Errors
            const scene = arContainer.querySelector('a-scene');
            const video = document.getElementById('ar-video');

            // Prime video on user touch (critical for iOS)
            // Even though we just clicked, we do it again here explicitly
            video.play().then(() => {
                video.pause();
                log("Video primed.");
            }).catch(e => log("Video prime warning: " + e.message));

            // MindAR Events for Camera
            scene.addEventListener('arReady', () => {
                log("AR Ready. Camera should be visible.");
            });

            scene.addEventListener('arError', (event) => {
                triggerError("Kamera xatosi (AR Error): " + (event.detail.error || "Unknown"));
            });

            // Target events
            const target = document.querySelector('[mindar-image-target]');
            target.addEventListener('targetFound', () => {
                log("Target Found!");
                video.play();
            });
            target.addEventListener('targetLost', () => {
                log("Target Lost.");
                video.pause();
            });
        }

        // Global Error Handler for Camera Constraints
        window.addEventListener('unhandledrejection', function (event) {
            if (event.reason && event.reason.name) {
                if (event.reason.name === 'NotAllowedError') {
                    triggerError("Kameraga ruxsat berilmadi!");
                } else if (event.reason.name === 'NotFoundError') {
                    triggerError("Kamera topilmadi!");
                }
            }
            log("Unhandled: " + event.reason);
        });

        fetchProject();

    </script>
</body>

</html>