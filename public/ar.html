<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <!-- 1. Responsive Fix: Strict viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PINHAN BOX - WebAR</title>

    <!-- A-Frame 1.4.2 & MindAR 1.2.5 -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* Base Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Outfit', sans-serif;
            /* Maintaining font consistency */
        }

        /* 
           2. Overlay Logic & 4. CSS Cleanup 
           Scan Overlay - Covers everything initially 
        */
        #scan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f0f;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            /* Topmost layer */
            transition: opacity 0.5s ease-out;
        }

        .logo-container {
            width: 150px;
            height: 150px;
            margin-bottom: 40px;
            /* 4. CSS Cleanup: Responsive container */
            max-width: 80%;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .btn-start {
            padding: 16px 40px;
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            border: none;
            border-radius: 50px;
            color: #000;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s;
        }

        .btn-start:active {
            transform: scale(0.95);
        }

        #error-msg {
            color: #ff4444;
            margin-top: 20px;
            font-size: 14px;
            display: none;
            text-align: center;
            padding: 0 20px;
        }

        /* 
           3. Z-Index Correction 
           Ensure video (camera feed) is background 
        */
        /* MindAR injects a video element. We target it globally carefully */
        video {
            /* This targets the camera feed primarily */
            position: absolute;
            top: 0;
            left: 0;
            z-index: -2 !important;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* The Canvas where A-Frame renders 3D */
        .a-canvas {
            z-index: 1 !important;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Custom UI on top of AR */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            pointer-events: none;
            /* Let clicks pass through to AR */
        }

        /* Recording Button */
        #btn-record {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 72px;
            height: 72px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 4px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            display: none;
            /* Hidden until started */
        }

        #btn-record::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 54px;
            height: 54px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s;
        }

        #btn-record.recording::after {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            /* Square stop icon */
            background: #ff4444;
        }

        #toast {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>

<body>

    <!-- 2. SCAN OVERLAY -->
    <div id="scan-overlay">
        <div class="logo-container">
            <img src="/watermark_logo.png" alt="Logo">
        </div>
        <button class="btn-start" id="btn-init">CAMERA</button>
        <p id="error-msg"></p>
        <p style="color: #666; font-size: 12px; margin-top: 15px;">v4.0 Mobile Optimized</p>
    </div>

    <!-- UI Layer for controls -->
    <div id="ui-layer">
        <div id="toast">Video saqlandi!</div>
        <div id="btn-record"></div>
    </div>

    <!-- AR Scene Container -->
    <div id="ar-scene-container"></div>

    <script>
        const uuid = new URLSearchParams(window.location.search).get('id');
        const overlay = document.getElementById('scan-overlay');
        const btnInit = document.getElementById('btn-init');
        const errorMsg = document.getElementById('error-msg');
        const arContainer = document.getElementById('ar-scene-container');
        const btnRecord = document.getElementById('btn-record');
        const toast = document.getElementById('toast');

        // State
        let projectData = null;
        let recorder = null;
        let chunks = [];
        let isRecording = false;

        // 1. Fetch Data immediately
        async function fetchProject() {
            if (!uuid) return showError("ID topilmadi. QR kodni qayta tekshiring.");

            try {
                const res = await fetch(`/api/project/${uuid}`);
                if (!res.ok) throw new Error("Loyiha topilmadi");
                projectData = await res.json();

                // Enable button once data is ready
                btnInit.innerText = "START CAMERA";
                btnInit.disabled = false;
            } catch (err) {
                showError("Xatolik: " + err.message);
            }
        }

        function showError(msg) {
            errorMsg.innerText = msg;
            errorMsg.style.display = 'block';
            btnInit.style.display = 'none';
        }

        function showToast(msg) {
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2500);
        }

        // 2. Start Button Logic
        btnInit.onclick = () => {
            if (!projectData) return;

            // Hide Overlay
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 500);

            // Init AR
            initAR(projectData);
        };

        function initAR(data) {
            // Calculate ratios
            const mRatio = data.markerRatio || 1.0;
            const vRatio = data.videoRatio || 1.0;
            const pHeight = 1 / mRatio; // Plane height relative to width 1

            // Object-fit logic for the video on the marker
            let repeat = "1 1", offset = "0 0";
            if (vRatio > mRatio) { // Video is wider than marker
                const s = mRatio / vRatio;
                repeat = `${s} 1`;
                offset = `${(1 - s) / 2} 0`;
            } else { // Video is taller/thinner
                const s = vRatio / mRatio;
                repeat = `1 ${s}`;
                offset = `0 ${(1 - s) / 2}`;
            }

            // 5. Autoplay Fix: Preload video
            // We construct the HTML string for valid A-Frame scene
            const sceneHTML = `
                <a-scene 
                    mindar-image="imageTargetSrc: ${data.mind}; uiLoading: no; uiScanning: yes; filterMinCF:0.0001; filterBeta: 0.001;" 
                    color-space="sRGB" 
                    renderer="colorManagement: true, physicallyCorrectLights: true, preserveDrawingBuffer: true" 
                    vr-mode-ui="enabled: false" 
                    device-orientation-permission-ui="enabled: false">
                    
                    <a-assets>
                        <!-- muted removed to allow sound, but handled via click -->
                        <!-- 5. Autoplay Fix: playsinline is critical for iOS -->
                        <video id="ar-video" src="${data.video}" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
                    </a-assets>

                    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

                    <a-entity mindar-image-target="targetIndex: 0">
                        <a-plane 
                            material="src: #ar-video; opacity: 1; transparent: false; repeat: ${repeat}; offset: ${offset}" 
                            position="0 0 0" 
                            width="1" 
                            height="${pHeight}">
                        </a-plane>
                    </a-entity>
                </a-scene>
            `;

            arContainer.innerHTML = sceneHTML;
            btnRecord.style.display = 'block';

            // Post-Injection Logic
            const scene = arContainer.querySelector('a-scene');
            const video = document.getElementById('ar-video');

            // 5. Autoplay: Unlock Audio on "Start" (User Gesture already happened)
            // We play and pause immediately to prime the video element
            video.play().then(() => {
                video.pause();
            }).catch(e => console.log("Autoplay prime failed:", e));

            scene.addEventListener('loaded', () => {
                const target = document.querySelector('[mindar-image-target]');

                target.addEventListener('targetFound', () => {
                    console.log("Target Found");
                    video.play();
                });

                target.addEventListener('targetLost', () => {
                    console.log("Target Lost");
                    video.pause();
                    video.currentTime = 0; // Optional: Reset
                });
            });

            setupRecording(scene);
        }

        // Recording Functionality (Preserved & Optimized)
        function setupRecording(scene) {
            const recCanvas = document.createElement('canvas');
            const recCtx = recCanvas.getContext('2d');
            const logo = new Image();
            logo.src = "/watermark_logo.png"; // Backend uses this path

            function mergeFrames() {
                if (!isRecording) return;

                const arCanvas = scene.components.screenshot.getCanvas('perspective');
                const videoFeed = document.querySelector('video:not(#ar-video)'); // The camera feed

                if (arCanvas) {
                    if (recCanvas.width !== arCanvas.width) {
                        recCanvas.width = arCanvas.width;
                        recCanvas.height = arCanvas.height;
                    }

                    // Draw Camera
                    if (videoFeed && videoFeed.readyState >= 2) {
                        // Aspect Ratio Crop logic could be complex, simple draw for now
                        // MindAR video is covered by strict CSS, so straightforward draw usually works
                        recCtx.drawImage(videoFeed, 0, 0, recCanvas.width, recCanvas.height);
                    } else {
                        recCtx.fillStyle = 'black';
                        recCtx.fillRect(0, 0, recCanvas.width, recCanvas.height);
                    }

                    // Draw AR
                    recCtx.drawImage(arCanvas, 0, 0);

                    // Draw Watermark
                    if (logo.complete) {
                        const logoW = recCanvas.width * 0.3; // 30% width
                        const logoH = logoW * (logo.naturalHeight / logo.naturalWidth);
                        const x = (recCanvas.width - logoW) / 2;
                        const y = recCanvas.height - logoH - 50;
                        recCtx.drawImage(logo, x, y, logoW, logoH);
                    }
                }

                requestAnimationFrame(mergeFrames);
            }

            btnRecord.onclick = () => {
                if (isRecording) {
                    // Stop
                    isRecording = false;
                    recorder.stop();
                    btnRecord.classList.remove('recording');
                } else {
                    // Start
                    isRecording = true;
                    btnRecord.classList.add('recording');
                    requestAnimationFrame(mergeFrames);

                    const stream = recCanvas.captureStream(30);
                    recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                    chunks = [];

                    recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
                    recorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Memories-${Date.now()}.webm`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        showToast("Video saqlandi!");
                    };
                    recorder.start();
                }
            };
        }

        // Init
        fetchProject();

    </script>
</body>

</html>