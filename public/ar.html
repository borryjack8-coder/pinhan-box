<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PINHAN BOX - WebAR Debug</title>

    <!-- MindAR & A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* 1. CSS "X-Ray" Fix & Transparency */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: transparent !important;
            /* Critical for camera see-through */
            overflow: hidden;
            font-family: monospace;
        }

        /* 2. Target MindAR's video element specifically */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -10 !important;
            /* Way behind */
            display: block !important;
            opacity: 1 !important;
        }

        /* The AR Canvas (3D Objects) */
        .a-canvas {
            z-index: 1 !important;
            background: transparent !important;
        }

        /* Overlay Styles */
        #scan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            /* Black initially */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #fff;
        }

        .btn-start {
            margin-top: 20px;
            padding: 15px 30px;
            background: #FFD700;
            color: #000;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        /* 3. On-Screen Debugger (CRITICAL) */
        #debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            /* Matrix green */
            font-size: 12px;
            padding: 10px;
            overflow-y: scroll;
            z-index: 10000;
            pointer-events: none;
            /* Let touches pass through */
            border-top: 2px solid #FFD700;
            display: block;
            /* Always visible for now */
        }
    </style>
</head>

<body>

    <!-- Debug Console -->
    <div id="debug-console">
        <div>> System Init...</div>
        <div>> Waiting for User to Start...</div>
    </div>

    <!-- Start Overlay -->
    <div id="scan-overlay">
        <h2>PINHAN BOX</h2>
        <p>AR Kamera Tizimi</p>
        <button class="btn-start" id="btn-init">KAMERANI OCHISH</button>
    </div>

    <!-- AR Container -->
    <div id="ar-container" style="width: 100%; height: 100%;"></div>

    <script>
        const debugDiv = document.getElementById('debug-console');
        const overlay = document.getElementById('scan-overlay');
        const btnInit = document.getElementById('btn-init');
        const arContainer = document.getElementById('ar-container');
        const uuid = new URLSearchParams(window.location.search).get('id');

        // Logger Function
        function log(msg, type = 'info') {
            const line = document.createElement('div');
            line.innerText = `> ${msg}`;
            if (type === 'error') line.style.color = '#ff4444';
            debugDiv.appendChild(line);
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(msg);
        }

        // Global Error Listeners
        window.onerror = function (msg, url, line) {
            log(`GLOBAL ERROR: ${msg} (Line ${line})`, 'error');
        };

        window.addEventListener('unhandledrejection', event => {
            log(`PROMISE ERROR: ${event.reason}`, 'error');
        });

        // 1. Fetch Data
        async function init() {
            if (!uuid) return log("No ID provided!", 'error');

            try {
                log(`Fetching project ${uuid}...`);
                const res = await fetch(`/api/project/${uuid}`);
                if (!res.ok) throw new Error("API Error: " + res.status);
                const data = await res.json();

                log("Data loaded. Ready.");
                btnInit.onclick = () => startAR(data);
            } catch (err) {
                log("Init Fail: " + err.message, 'error');
            }
        }

        // 2. Start AR
        function startAR(data) {
            log("User clicked START.");

            // Hide overlay
            overlay.style.display = 'none';
            // Set body background transparent now
            document.body.style.background = 'transparent';

            // Calculate Aspect
            const mRatio = data.markerRatio || 1.0;
            const vRatio = data.videoRatio || 1.0;
            const pHeight = 1 / mRatio;

            let repeat = "1 1", offset = "0 0";
            if (vRatio > mRatio) {
                const s = mRatio / vRatio;
                repeat = `${s} 1`;
                offset = `${(1 - s) / 2} 0`;
            } else {
                const s = vRatio / mRatio;
                repeat = `1 ${s}`;
                offset = `0 ${(1 - s) / 2}`;
            }

            log("Injecting A-Scene...");

            // Config: uiLoading: no to prevent conflicts
            const sceneHTML = `
                <a-scene 
                    mindar-image="imageTargetSrc: ${data.mind}; uiLoading: no; uiScanning: no; uiError: no;" 
                    color-space="sRGB" 
                    renderer="colorManagement: true, preserveDrawingBuffer: true" 
                    vr-mode-ui="enabled: false" 
                    device-orientation-permission-ui="enabled: false">
                    
                    <a-assets>
                        <video id="ar-video" src="${data.video}" preload="auto" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
                    </a-assets>

                    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

                    <a-entity mindar-image-target="targetIndex: 0">
                        <a-plane 
                            material="src: #ar-video; opacity: 1; transparent: false; repeat: ${repeat}; offset: ${offset}" 
                            position="0 0 0" 
                            width="1" 
                            height="${pHeight}">
                        </a-plane>
                    </a-entity>
                </a-scene>
            `;

            arContainer.innerHTML = sceneHTML;

            // 3. User Gesture - Prime Video
            const video = document.getElementById('ar-video');
            video.play().then(() => {
                video.pause();
                log("Content video primed.");
            }).catch(e => log("Content video prime fail: " + e.message, 'error'));

            // 4. Force Resize Hack
            setTimeout(() => {
                log("Triggering RESIZE event...");
                window.dispatchEvent(new Event('resize'));
            }, 500);

            // Listen for MindAR events
            const scene = document.querySelector('a-scene');

            scene.addEventListener('arReady', () => {
                log("EVENT: arReady (Camera should be starting)");
            });

            scene.addEventListener('arError', (e) => {
                log("EVENT: arError - " + (e.detail ? e.detail.error : 'Unknown'), 'error');
            });
        }

        init();
    </script>
</body>

</html>